<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<script src="/_resource/js/_js_initialLoadFiles.min.js"></script>
</head>
<body>

<h1>逐步實作大型網站資料庫所需要的三層式複寫架構</h1>

<p>在一個大型網站的設定裡，資料庫所要承載的壓力其實是非常的重的，因此我們往往需要複寫的機制來完成所謂的資料庫負載平衡，最近剛好有在研究這一塊領域，於是就把正確的逐一做法（Step By Step）放到上面來，讓有需要的人自行取用之，縮短大家研究資料庫複寫的時間。在這邊文章中，所進行的主機架構為三層，也就是「發行者」、「散發者」、「訂閱者」三台機器是分開的，而並非各位在網路上常見的雙層式架構「發行者（兼散發者）」、「訂閱者」，理論上來說三層式的效果來說才是最優秀的，因為發行者機器其實就是最累的主要資料庫，不應該再加諸任何功能於身才是。設定架構如下圖所示：</p>

<a href="https://www.flickr.com/photos/105479788@N06/20510651750/"><img src="https://c1.staticflickr.com/5643/20510651750_94aa3572c9_o.png" alt="20150819_01"></a>

<p>以下是三台機器的名稱以及ＩＰ資訊：</p>
<p>發行者 Publisher		<br>SQL-A 192.168.1.1</p>
<p>散發者 Distributor	<br>SQL-B 192.168.1.2</p>
<p>訂閱者 Subscriber	<br>SQL-C 192.168.1.3</p>

<h3>開始進行三層式複寫架構的設定</h3>
<p>Step 01. 將三台機器的防火牆，都開啟1433 Port以利資料庫間進行溝通連線。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20672578126/"><img src="https://c1.staticflickr.com/5662/20672578126_a25eb2f4d4_o.png" alt="20150819_02"></a>

<p>Step 02. 將三台機器都用系統管理員身分開啟記事本，來解決整個網域間沒有AD（Active Directory）的問題。如果你已經有了AD架構，那麼請忽略這些步驟。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20689572122/"><img src="https://c1.staticflickr.com/686/20689572122_795dd14c55_o.png" alt="20150819_03"></a>

<p>Step 03. 用記事本去開啟「C:\Windows\System32\drivers\etc」下的「hosts」檔案，並進行主機名稱對映IP的編輯工作。其中：</p>
<ol>
	<li>SQL-A 添加：SQL-B 192.168.1.2</li>
	<li>SQL-B 添加：SQL-A 192.168.1.1</li>
	<li>SQL-C 添加：SQL-A 192.168.1.1、SQL-B 192.168.1.2</li>
</ol>
<a href="https://www.flickr.com/photos/105479788@N06/20689572112/"><img src="https://c1.staticflickr.com/657/20689572112_d0344e098f_o.png" alt="20150819_04"></a>

<p>Step 04. 因為資料交換的過程中，會用到網路分享協定（SMB、CIFS），因此請將三台伺服器中的網路卡（要選準備互相溝通的那一塊喔，不要勾錯塊網路卡了）開啟內容選單，並進行下列的設定</p>
<ol>
	<li>SQL-A 勾選：Client for Microsoft Networks</li>
	<li>SQL-B 勾選：Client for Microsoft Networks、File and Printer Sharing for Microsoft Networks</li>
	<li>SQL-C 勾選：Client for Microsoft Networks</li>
</ol>
<a href="https://www.flickr.com/photos/105479788@N06/20690095112/"><img src="https://c1.staticflickr.com/675/20690095112_559125bb2b_o.png" alt="20150819_05"></a>

<p>Step 05. 設定一組三台伺服器都是同樣的帳號密碼之伺服器帳號，這個帳號未來為套用到SQL Server Agent之執行身分，並且被用在網路分享協定之帳號密碼上。</p>
<ol>
	<li>SQL-A 新增：使用者帳號 DbDeplication／密碼 三台都一樣就好</li>
	<li>SQL-B 新增：使用者帳號 DbDeplication／密碼 三台都一樣就好</li>
	<li>SQL-C 新增：使用者帳號 DbDeplication／密碼 三台都一樣就好</li>
</ol>
<a href="https://www.flickr.com/photos/105479788@N06/20511350980/"><img src="https://c1.staticflickr.com/571/20511350980_4ca24fd568_o.png" alt="20150819_06"></a>

<p>Step 06. 綁定三台機器的SQL Server Agent服務，都指定到使用DbDeplication執行，將服務設定為自動啟動，並請啟動它吧。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20512710709/"><img src="https://c1.staticflickr.com/5723/20512710709_7abe83882c_o.png" alt="20150819_07"></a>

<h3>散發者設定</h3>

<p>Step 07. 由於SQL-B是散發者，因此我們需要為它設定一個專門用來存放快照集的SMB、CIFS資料夾，命名為「DbRepl」，並將此資料夾指派本機的存取權限給DbDeplication。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20512952369/"><img src="https://c1.staticflickr.com/5806/20512952369_171f330cbb_o.png" alt="20150819_08"></a>

<p>Step 08. 當然，指派SMB、CIFS的存取權限也是不可缺少的。這一步驟設定完成，系統會自動幫你在防火牆開啟網路芳鄰會用到的相關通訊埠號，喜歡更精確設定的人可以自行去開關。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20512952749/"><img src="https://c1.staticflickr.com/668/20512952749_7ce39380db_o.png" alt="20150819_09"></a>

<p>Step 09. 我們要先設定SQL-B就是散發者。請到SQL-B開啟MSSMS（Microsoft SQL Server Management Studio）＞複寫＞設定散發，運行設定散發精靈。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20077555174/"><img src="https://c1.staticflickr.com/701/20077555174_39dea45b67_o.png" alt="20150819_10"></a>

<p>Step 10. 對，SQL-B本身就是散發者，決定就是你了皮卡丘。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20512128330/"><img src="https://c1.staticflickr.com/671/20512128330_9caca5ca41_o.png" alt="20150819_11"></a>

<p>Step 11. 這裡限定只能使用網路路徑（UNC Path），所以剛才如果沒有設定SMB、CIFS的人，這下就慘了。其實精靈也已經跟你講得很清楚了，它只能記下來，但根本不知道你設定是否正確，所以沒有設定的人可以趕快跳出去設定，一切都還來的及。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20079175873/"><img src="https://c1.staticflickr.com/5691/20079175873_a294a2dbfc_o.png" alt="20150819_12"></a>

<p>Step 12. 指定散發資料庫「distribution」與其儲存路徑，這邊用預設值就好。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20690860992/"><img src="https://c1.staticflickr.com/5672/20690860992_9c4844b298_o.png" alt="20150819_13"></a>

<p>Step 13. 這裡詢問的是，哪一個發行者可以使用這個散發資料庫？</p>
<a href="https://www.flickr.com/photos/105479788@N06/20706919331/"><img src="https://c1.staticflickr.com/5780/20706919331_d3ba8db861_o.png" alt="20150819_14"></a>

<p>Step 14. 把SQL-A加進來吧！</p>
<a href="https://www.flickr.com/photos/105479788@N06/20079175653/"><img src="https://c1.staticflickr.com/618/20079175653_4a6cbd3c5c_o.png" alt="20150819_15"></a>

<p>Step 15. 發行者連到散發者來進行複寫管理作業時，是需要使用到密碼的，由於我們是第一次使用，因此需要自訂一個新的密碼。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20512131778/"><img src="https://c1.staticflickr.com/5659/20512131778_e2989a09a0_o.png" alt="20150819_16"></a>

<p>Step 16. 快完工了，設定散發。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20513381839/"><img src="https://c1.staticflickr.com/752/20513381839_e3c4ff6b79_o.png" alt="20150819_17"></a>

<p>Step 17. 確認所有的設定資訊。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20673863296/"><img src="https://c1.staticflickr.com/663/20673863296_39601bf2e7_o.png" alt="20150819_18"></a>

<p>Step 18. 看到綠色勾勾，真是令人愉快！</p>
<a href="https://www.flickr.com/photos/105479788@N06/20079175733/"><img src="https://c1.staticflickr.com/5649/20079175733_b907897936_o.png" alt="20150819_19"></a>

<h3>發行者設定</h3>

<p>Step 19. 身為發行者的SQL-A，一進入後不是先去做發行集的設定，而是先去設定散發精靈，根系統講說，我是發行者，但是我的散發伺服器在另外一台。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20512416950/"><img src="https://c1.staticflickr.com/686/20512416950_1dbf36d143_o.png" alt="20150819_20"></a>

<p>Step 20. 從下圖中可以發現我們正在SQL-A，但是要指定SQL-B為我們的散發者，請點選「加入」按鈕。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20691147892/"><img src="https://c1.staticflickr.com/5750/20691147892_ee5fa41eac_o.png" alt="20150819_21"></a>

<p>Step 21. 當然是輸入SQL-B的SA帳號密碼了。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20691148332/"><img src="https://c1.staticflickr.com/598/20691148332_70531da28d_o.png" alt="20150819_22"></a>

<p>Step 22. 找到SQL-B了！</p>
<a href="https://www.flickr.com/photos/105479788@N06/20700412045/"><img src="https://c1.staticflickr.com/779/20700412045_99c5f87a69_o.png" alt="20150819_23"></a>

<p>Step 23. 之前就有設定過，發行者連入進行複寫管理作業時，是需要使用到密碼的。
</p>
<a href="https://www.flickr.com/photos/105479788@N06/20674155266/"><img src="https://c1.staticflickr.com/5739/20674155266_808e1b2bf4_o.png" alt="20150819_24"></a>

<p>Step 24. 準備結束了。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20079467033/"><img src="https://c1.staticflickr.com/5747/20079467033_586845ecf1_o.png" alt="20150819_25"></a>

<p>Step 25. 看一下散發精靈的總結資訊。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20674155256/"><img src="https://c1.staticflickr.com/5685/20674155256_2e88106975_o.png" alt="20150819_26"></a>

<p>Step 26. 又開心地看到綠色勾勾了。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20674154136/"><img src="https://c1.staticflickr.com/5670/20674154136_042be8a3f7_o.png" alt="20150819_27"></a>

<p>Step 27. 設定發行集之前，讓我們先來確定一下要發送的資料庫資訊。</p>
<p>資料庫：SlashLook</p>
<p>資料表：Employee</p>
<p>資料表欄位：iAutoIndex（PK, Primary Key）、cName</p>
<a href="https://www.flickr.com/photos/105479788@N06/20701046135/"><img src="https://c1.staticflickr.com/772/20701046135_ac9c87dffe_o.png" alt="20150819_28"></a>

<p>Step 28. 進入發行集精靈嘍！</p>
<a href="https://www.flickr.com/photos/105479788@N06/20514300049/"><img src="https://c1.staticflickr.com/5652/20514300049_1395f287f9_o.png" alt="20150819_29"></a>

<p>Step 29. 選擇我們要發行的資料庫。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20674789516/"><img src="https://c1.staticflickr.com/703/20674789516_dcf13d3076_o.png" alt="20150819_30"></a>

<p>Step 30. 這一次我們要進行的是交易式發行集。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20674789396/"><img src="https://c1.staticflickr.com/5659/20674789396_3352a97eee_o.png" alt="20150819_31"></a>

<p>Step 31. 全部的資料表與欄位都發行過去了。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20514299439/"><img src="https://c1.staticflickr.com/765/20514299439_2e37dcfd2f_o.png" alt="20150819_32"></a>

<p>Step 32. 若有需要進行資料篩選的人，可以在這邊篩掉一些機敏性資料。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20513051658/"><img src="https://c1.staticflickr.com/5740/20513051658_84594f336e_o.png" alt="20150819_33"></a>

<p>Step 33. 立即建立快照集。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20514299169/"><img src="https://c1.staticflickr.com/687/20514299169_f91e128727_o.png" alt="20150819_34"></a>

<p>Step 34. 指定快照集的代理程式，當然是選SQL Server Agent這個好夥伴啦！請點選安全性設定。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20080098603/"><img src="https://c1.staticflickr.com/5755/20080098603_9305ffef89_o.png" alt="20150819_35"></a>

<p>Step 35. 選擇SQL Server Agent，發行者請輸入SQL-A的SA帳號密碼。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20701045425/"><img src="https://c1.staticflickr.com/586/20701045425_037d95ee03_o.png" alt="20150819_36"></a>

<p>Step 36. 確認一下快照集代理程式的身分資訊。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20674788816/"><img src="https://c1.staticflickr.com/5703/20674788816_5ea62930fe_o.png" alt="20150819_37"></a>

<p>Step 37. 精靈結束後建立發行集。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20080097303/"><img src="https://c1.staticflickr.com/5817/20080097303_3260b06ab9_o.png" alt="20150819_38"></a>

<p>Step 38. 幫你的發行集取一個名稱吧！</p>
<a href="https://www.flickr.com/photos/105479788@N06/20513043880/"><img src="https://c1.staticflickr.com/737/20513043880_d1b0735f88_o.png" alt="20150819_39"></a>

<p>Step 39. 看到綠色勾勾就是開心的時刻。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20691776552/"><img src="https://c1.staticflickr.com/5815/20691776552_9909275739_o.png" alt="20150819_40"></a>

<p>Step 40. 此刻，回去SQL-B（散發者）端，我們已經發現SQL-A已經將快照集推送過來了。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20513051918/"><img src="https://c1.staticflickr.com/5762/20513051918_fc434cf543_o.png" alt="20150819_41"></a>

<h3>訂閱者設定</h3>

<p>Step 41. 終於走到了訂閱的步驟了！</p>
<a href="https://www.flickr.com/photos/105479788@N06/20081048163/"><img src="https://c1.staticflickr.com/772/20081048163_9ff65108cf_o.png" alt="20150819_42"></a>

<p>Step 42. 讓我們來找出發行者（SQL-A）吧！</p>
<a href="https://www.flickr.com/photos/105479788@N06/20513997150/"><img src="https://c1.staticflickr.com/5774/20513997150_36a00ebcff_o.png" alt="20150819_43"></a>

<p>Step 43. 輸入SQL-A的SA帳號密碼。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20513997050/"><img src="https://c1.staticflickr.com/678/20513997050_ded8601497_o.png" alt="20150819_44"></a>

<p>Step 44. 找到發行集啦！找到喇叭商標啦！</p>
<a href="https://www.flickr.com/photos/105479788@N06/20701994465/"><img src="https://c1.staticflickr.com/5700/20701994465_7b7668ca91_o.png" alt="20150819_45"></a>

<p>Step 45. 為求效能最佳化，當然是自己的訂閱自己拿！</p>
<a href="https://www.flickr.com/photos/105479788@N06/20675742056/"><img src="https://c1.staticflickr.com/5790/20675742056_437a687762_o.png" alt="20150819_46"></a>

<p>Step 46. 別忘了訂閱者（SQL-C）的資料庫現在還是空的，當然是建立一個資料庫桶子以利進行複寫工作啊！建議名稱與原始發送過來的資料庫桶子名稱一致，日後會比較好管理。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20701994435/"><img src="https://c1.staticflickr.com/5766/20701994435_db7ff3d4e3_o.png" alt="20150819_47"></a>

<p>Step 47. 輸入要複寫過來的資料庫桶子名稱。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20701994405/"><img src="https://c1.staticflickr.com/5707/20701994405_f89493216a_o.png" alt="20150819_48"></a>

<p>Step 48. 下一步。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20514000408/"><img src="https://c1.staticflickr.com/5818/20514000408_8600a1481a_o.png" alt="20150819_49"></a>

<p>Step 49. 接下來是指定散發代理程式的安全性，也就是SQL Server Agent啦！請點選圖中的「…」進行設定。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20708799671/"><img src="https://c1.staticflickr.com/739/20708799671_c541b21bbd_o.png" alt="20150819_50"></a>

<p>Step 50. 當然是選SQL Server Agent來當我們的散發代理程式的處理者。此外，連接到散發者處，請輸入SQL-B的SA帳號密碼。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20513998868/"><img src="https://c1.staticflickr.com/748/20513998868_325dcdf240_o.png" alt="20150819_51"></a>

<p>Step 51. 下一步。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20692728192/"><img src="https://c1.staticflickr.com/5750/20692728192_c903ae9588_o.png" alt="20150819_52"></a>

<p>Step 52. 為了確保資料的同步性，選擇連續執行。如果資料變異過大且資料數量很龐大，可以在這個地方選擇排程式運行。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20515249389/"><img src="https://c1.staticflickr.com/656/20515249389_b38bbc2db2_o.png" alt="20150819_53"></a>

<p>Step 53. 立即初始化。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20515249639/"><img src="https://c1.staticflickr.com/577/20515249639_59a0fbd69d_o.png" alt="20150819_54"></a>

<p>Step 54. 建立訂閱。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20081047643/"><img src="https://c1.staticflickr.com/5644/20081047643_9f1f43d408_o.png" alt="20150819_55"></a>

<p>Step 55. 檢視訂閱精靈的總設定資訊，按完成後應該就可以看到令人開心的綠色勾勾啦！</p>
<a href="https://www.flickr.com/photos/105479788@N06/20708799331/"><img src="https://c1.staticflickr.com/5715/20708799331_553cfd3014_o.png" alt="20150819_56"></a>

<h3>接下來就是見證奇蹟的時刻了</h3>

<p>Step 56. 先到訂閱者SQL-C，確定資料表已經有複寫過來啦！</p>
<a href="https://www.flickr.com/photos/105479788@N06/20692728002/"><img src="https://c1.staticflickr.com/5667/20692728002_54c540b5d1_o.png" alt="20150819_57"></a>

<p>Step 57. 我們到發行者SQL-A，把張三改名字，砍掉王五這筆資料，並新增陳六資料。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20079426654/"><img src="https://c1.staticflickr.com/680/20079426654_b03a2ee288_o.png" alt="20150819_58"></a>

<p>Step 58. 接著馬上到SQL-C重新整理，發現資料庫的異動都被即時複寫過來啦！如果你細心一點，應該可以發現「iAutoIndex: 3」不見了，這就是為何複寫一張資料表，該表需要有設定PK的原因。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20079426634/"><img src="https://c1.staticflickr.com/719/20079426634_9d331304e5_o.png" alt="20150819_59"></a>

<p>以上就是這篇三層式複寫架構的一步步說明，希望可以節省掉你大量的錯誤測試、摸索的時間。</p>

<p>如果有一些人為了追求更高的安全性，在Step 35連入發行者、或Step 50連入散發者作業的時候，選擇了「藉由模擬處理帳戶」、或者是「非最高權限管理員SA」的資料庫使用者（成員），那麼極有可能會出現複寫作業失敗，這時候不妨請您回到SQL-A、SQL-B的MSSMS中，看一下「安全性」→「登入」→「新增登入」，看看是否有該名使用者被授權在這個資料庫中運行？例如：SQL-A發行者資料庫的某使用者，應該要可以使用SlashLook資料庫桶子才對，又例如：SQL-B散發者資料庫的某使用者，應該要可以使用distribution資料庫桶子才對。</p>

<small>StepByStep SQLServerReplication DatabaseReplication TransactionalReplication Publisher Distributor Subscriber</small>

</body>
</html>
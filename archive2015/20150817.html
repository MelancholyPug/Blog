<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<script src="/_resource/js/_js_initialLoadFiles.min.js"></script>
</head>
<body>

<h1>快速逐步的實作SQL Server之主從複寫機制</h1>

<p>要好好地設定一個Microsoft SQL Server的複寫機制，中間涉及到的資料庫及作業系統等級的權限以及設定、UNC或是FTP，沒有花上一小時是搞不定的。原因無它，安全而已。但是有時候在戰場上面不可能允許我們像學術派如此的輕鬆，結案時間可是不饒人的，因此我們今天要討論的是如何在某一寬鬆程度的假設下，快速完成資料庫之間的複寫機制。請先確定你的資料庫中，要從SQL-A複寫到SQL-B的資料表，具備了PK（Primary Key）的資料結構設計。例如下圖中位於SQL-A資料庫Employee資料表，其iAutoIndex欄位即為此表之PK。</p>

<a href="https://www.flickr.com/photos/105479788@N06/20024345614/in/photostream/"><img src="https://c1.staticflickr.com/5819/20024345614_b62c3b581a_b.jpg" alt="20150817_01"></a>

<p>主機及網路配置如下：</p>
<ol>
	<li>發行端（在此例亦作為散發端）	電腦名稱：ＳＱＬ－Ａ	192.168.1.1</li>
	<li>訂閱端　　　　　　　　　　　	電腦名稱：ＳＱＬ－Ｂ	192.168.1.2</li>
</ol>

<p>實作前的假設條件如下：</p>
<ol>
	<li>發行端（散發端）與訂閱端都「沒有、不需要」加入AD網域或架構（Active Directory）。</li>
	<li>發行端（散發端）要發送的資料表，我確定都已經有PK（Primary Key）了，如上圖所示。</li>
	<li>發行端（散發端）的作業系統，我擁有最高權限。（Administrator）</li>
	<li>發行端（散發端）的資料庫，我擁有最高權限。（SA）</li>
	<li>我不在乎發行端（散發端）的主機效能。</li>
	<li>訂閱端的資料庫，我擁有最高權限。（SA）</li>
</ol>

<h3>開始設定兩台資料庫之間的交易式複寫機制</h3>
<p>Step 01. 先把SQL-A以及SQL-B資料庫主機中的防火牆，開啟1433 Port，以利後續溝通。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20620658136/in/photostream/"><img src="https://c1.staticflickr.com/692/20620658136_757bf52d86_b.jpg" alt="20150817_02"></a>

<p>Step 02. 在SQL-A端主機，以系統管理員身分打開記事本。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20025986833/in/photostream/"><img src="https://c1.staticflickr.com/763/20025986833_daee9251b5_b.jpg" alt="20150817_03"></a>

<p>Step 03. 到「C:\Windows\System32\drivers\etc」下找到「hosts」檔案，並利用剛才打開的記事本編輯它。因為我們沒有AD，因此只好利用這個方式將SQL-B的IP 192.168.1.2加入到列表中。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20620658016/in/photostream/"><img src="https://c1.staticflickr.com/631/20620658016_e76180be2c_b.jpg" alt="20150817_04"></a>

<p>Step 04. 在SQL-A端主機，打開SQL Server 2014組態管理員。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20620657976/in/photostream/"><img src="https://c1.staticflickr.com/653/20620657976_80b3edc388_b.jpg" alt="20150817_05"></a>

<p>Step 05. 按下右鍵啟動SQL Server Agent。此外，如果可以的話，建議到服務裡面，設定自動啟動SQL Server Agent，而不是預設的手動啟動模式。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20646912705/in/photostream/"><img src="https://c1.staticflickr.com/609/20646912705_ee71f70154_b.jpg" alt="20150817_06"></a>

<p>Step 06. 打開SQL-A端的MSSMS（Microsoft SQL Server Management Studio），在複寫＞本機發行集上面按右鍵，點選新增發行集。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20646912615/in/photostream/"><img src="https://c1.staticflickr.com/776/20646912615_541feef4eb_b.jpg" alt="20150817_07"></a>

<p>Step 07. 進入新增發行集精靈選單。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20460195949/in/photostream/"><img src="https://c1.staticflickr.com/5749/20460195949_1c0a5706a3_b.jpg" alt="20150817_08"></a>

<p>Step 08. 指定SQL-A本身亦為散發者。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20646912505/in/photostream/"><img src="https://c1.staticflickr.com/683/20646912505_1793cd0b14_b.jpg" alt="20150817_09"></a>

<p>Step 09. 精靈會警告你，系統將會自動啟動SQL Server Agent服務。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20653580411/in/photostream/"><img src="https://c1.staticflickr.com/612/20653580411_8fa456ebd4_b.jpg" alt="20150817_10"></a>

<p>Step 10. 指定快照集資料夾「ReplData」，在這裡我們使用系統預設的路徑，不進行變更。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20458908518/in/photostream/"><img src="https://c1.staticflickr.com/618/20458908518_219941a004_b.jpg" alt="20150817_11"></a>

<p>Step 11. 指定要建立發行的資料庫桶子「SlashLook」。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20637764882/in/photostream/"><img src="https://c1.staticflickr.com/634/20637764882_dcbb92e301_b.jpg" alt="20150817_12"></a>

<p>Step 12. 因為我們要進行的是單向的從SQL-A將資料表抄寫到SQL-B，因此我們選擇建立的是「交易式發行集」。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20620657726/in/photostream/"><img src="https://c1.staticflickr.com/623/20620657726_9049247b1e_b.jpg" alt="20150817_13"></a>

<p>Step 13. 指定要抄寫哪一些SQL-A的資料表到SQL-B去。從下圖中我們也可以發現，你可以只選擇到某些欄位發送過去就好，如此一來可以保留一些機敏性資料不要發行過去。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20025986373/in/photostream/"><img src="https://c1.staticflickr.com/5762/20025986373_e2c21e8b74_b.jpg" alt="20150817_14"></a>

<p>Step 14. 你可以更進一步的加入一些SQL指令，來過濾出你不想要被複寫過去的機敏性資料。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20460195699/in/photostream/"><img src="https://c1.staticflickr.com/738/20460195699_f7b6791456_b.jpg" alt="20150817_15"></a>

<p>Step 15. 選擇發行端立即建立快照集，讓等一下訂閱端可以方便的初始化。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20458908278/in/photostream/"><img src="https://c1.staticflickr.com/738/20458908278_68e0c18e55_b.jpg" alt="20150817_16"></a>

<p>Step 16. 「代理程式安全性」這部分需要好好的被設定，我們點選「安全性設定」。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20024344984/in/photostream/"><img src="https://c1.staticflickr.com/633/20024344984_1923c64a2a_b.jpg" alt="20150817_17"></a>

<p>Step 17. 「執行快照集代理程式」這裡，我們指定了「SQL-A\Administrator」帳號供給執行。至於「連接到發行者」這裡，當然就是給SQL-A資料庫的SA帳號密碼了。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20460195569/in/photostream/"><img src="https://c1.staticflickr.com/5783/20460195569_932f0f7f14_b.jpg" alt="20150817_18"></a>

<p>Step 18. 按下確定退出到主設定精靈後，點選下一步。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20620657476/in/photostream/"><img src="https://c1.staticflickr.com/692/20620657476_d70560cb8e_b.jpg" alt="20150817_19"></a>

<p>Step 19. 在精靈結束後，建立發行集。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20458908098/in/photostream/"><img src="https://c1.staticflickr.com/5683/20458908098_4560cb0587_b.jpg" alt="20150817_20"></a>

<p>Step 20. 建立發行集名稱，在這裡我們輸入了「CompanyData」。要注意的是，一個發行集裡面允許有多個發行項目（資料表），日後都可以再增添修改，因此這裡的名稱你可以取成比較廣泛一點的定義。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20637764552/in/photostream/"><img src="https://c1.staticflickr.com/5691/20637764552_c38fa0634d_b.jpg" alt="20150817_21"></a>

<p>Step 21. 接下來會顯示進度視窗，沒問題的話理論上都是綠色的勾勾才是。下圖中設定發散者處呈現的黃色驚嘆號，是在說明我們沒有跑到Windows的服務裡面，把SQL Server Agent設定成自動啟動。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20458915470/in/photostream/"><img src="https://c1.staticflickr.com/5695/20458915470_1ec0fd3827_b.jpg" alt="20150817_22"></a>

<p>Step 22. 回到SQL-A的MSSMS後，在本機發行集選單上面應該會出現一個有「CompanyData」字樣的發行集，請在上面右鍵＞新增訂閱。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20653579841/in/photostream/"><img src="https://c1.staticflickr.com/5755/20653579841_90ba87144e_b.jpg" alt="20150817_23"></a>

<p>Step 23. 進入訂閱精靈畫面。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20637764432/in/photostream/"><img src="https://c1.staticflickr.com/766/20637764432_370dca33a6_b.jpg" alt="20150817_24"></a>

<p>Step 24. 指定發行端為SQL-A，發行資料庫為「SlashLook」、發行集就是我們之前建立的「CompanyData」。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20458915390/in/photostream/"><img src="https://c1.staticflickr.com/569/20458915390_9cdc8190c4_b.jpg" alt="20150817_25"></a>

<p>Step 25. 指定在散發者端執行所有的代理程式。當然啦，以大型網站來說，這樣的設定要特別注意效能上的問題。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20458907798/in/photostream/"><img src="https://c1.staticflickr.com/5732/20458907798_6aba39c030_b.jpg" alt="20150817_26"></a>

<p>Step 26. 接下來是設定訂閱者，點選「加入SQL Server訂閱者」。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20458907748/in/photostream/"><img src="https://c1.staticflickr.com/638/20458907748_9a35746a03_b.jpg" alt="20150817_27"></a>

<p>Step 27. 這時候我們之前做的hosts檔案就派上用場啦！請大方的填入目標對象（訂閱者）為SQL-B，並輸入該資料庫的SA帳號密碼。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20620656986/in/photostream/"><img src="https://c1.staticflickr.com/590/20620656986_d84601b1e5_b.jpg" alt="20150817_28"></a>

<p>Step 28. 從SQL-A發行到SQL-B的資料庫後，要寫在哪個資料庫桶子中？請下拉選擇新增資料庫，我們將創造一個全新的資料庫桶子。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20637764202/in/photostream/"><img src="https://c1.staticflickr.com/755/20637764202_c99a9d1078_b.jpg" alt="20150817_29"></a>

<p>Step 29. 當然啦，建議與SQL-A端的資料庫桶子名稱一致，日後會比較好維護與回憶。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20620656876/in/photostream/"><img src="https://c1.staticflickr.com/5628/20620656876_8282d6c77f_b.jpg" alt="20150817_30"></a>

<p>Step 30. 接下來是設定「散發代理程式安全性」，請點選圖中的「…」做進階設定。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20025985793/in/photostream/"><img src="https://c1.staticflickr.com/5770/20025985793_6d7227e35e_b.jpg" alt="20150817_31"></a>

<p>Step 31. 散發代理程式之電腦帳戶，當然是設定成SQL-A\Administrator來進行運作。而連接到訂閱者的部分，當然是輸入SQL-B端的資料庫SA帳號密碼。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20637764092/in/photostream/"><img src="https://c1.staticflickr.com/597/20637764092_ac68e6a63c_b.jpg" width="1024" height="830" alt="20150817_32"></a>

<p>Step 32. 回到母設定畫面，一切備齊沒問題後點選下一步。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20458907488/in/photostream/"><img src="https://c1.staticflickr.com/676/20458907488_ba5ccc8365_b.jpg" alt="20150817_33"></a>

<p>Step 33. 代理程式我們選擇「連續式執行」。如果你有效能上的考量的話，也可以在這邊改成是「排程式執行」。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20637763952/in/photostream/"><img src="https://c1.staticflickr.com/666/20637763952_1d85d47113_b.jpg" alt="20150817_34"></a>

<p>Step 34. 當然是命令訂閱者馬上給我初始化。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20620656666/in/photostream/"><img src="https://c1.staticflickr.com/5702/20620656666_041ccb668b_b.jpg" alt="20150817_35"></a>

<p>Step 35. 精靈結束後建立訂閱。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20458914950/in/photostream/"><img src="https://c1.staticflickr.com/5742/20458914950_27948091cd_b.jpg" alt="20150817_36"></a>

<p>Step 36. 結束精靈前檢視所有的設定屬性，請點選完成。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20458914830/in/photostream/"><img src="https://c1.staticflickr.com/580/20458914830_6bee711121_b.jpg" alt="20150817_37"></a>

<p>Step 37. 如果設定都沒問題的話，就可以開心的看到綠色勾勾。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20620656526/in/photostream/"><img src="https://c1.staticflickr.com/610/20620656526_ea11628bc0_b.jpg" alt="20150817_38"></a>

<p>Step 38. 回到SQL-A的MSSMS，在樹狀選單本機發行集中，應該可以看到建立的CompanyData發行集，其中有一台叫做SQL-B的資料庫，已經對SlashLook資料庫桶子進行訂閱了。請在這上面按右鍵＞啟動複寫監視器，讓我們來看一下運作狀況。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20458914740/in/photostream/"><img src="https://c1.staticflickr.com/733/20458914740_c5f910bf7a_b.jpg" alt="20150817_39"></a>

<p>Step 39. 狀況看起來一切都很好，呈現了綠色的勾勾。如果狀況不對的話，會給你紅色的叉叉，並載明一些錯誤原因。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20458907138/in/photostream/"><img src="https://c1.staticflickr.com/5752/20458907138_5e47e2c8dd_b.jpg" alt="20150817_40"></a>

<p>Step 40. 讓我們回到SQL-B的MSSMS，看一下SQL-A資料庫的表格，是否有發行到SQL-B了，結果確定是有的。本機訂閱的部分亦出現來自於SQL-A的發行資訊。</p>
<a href="https://www.flickr.com/photos/105479788@N06/20646911315/in/photostream/"><img src="https://c1.staticflickr.com/658/20646911315_0a0aca35fc_b.jpg" alt="20150817_41"></a>

<p>最後，你可以試著自己進行一下SQL-A發行的資料表的CRUD，當你進行資料的變更後，去SQL-B重新整理，會發現資料馬上同步變更喔！熟練的話，以上的步驟全部跑完花不了你10分鐘的時間，是不是既簡單又快速呢？</p>

<small>StepByStep SQLServerReplication NoActiveDirectory MicrosoftSQLServerManagementStudio MSSMS SQLServerManagementStudio SSMS</small>

</body>
</html>